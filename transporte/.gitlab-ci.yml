stages:
  - build
  - push
  - generate

# Etapa de build de imagen Docker
build-docker:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  before_script:
    - apk add --no-cache git
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest .
  only:
    - main

# Etapa opcional para subir la imagen a Docker Hub o GitLab Container Registry
push-docker:
  stage: push
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  script:
       # Loguearse en DockerHub usando las variables de entorno
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # Construir la imagen de Docker y etiquetarla correctamente
    - docker build -t $DOCKERHUB_USERNAME/$IMAGE_NAME:latest -f Dockerfile .

    # Verificar que la imagen fue creada
    - docker images

    # Subir la imagen a DockerHub
    - docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
  only:
    - main

# Generaci√≥n del cliente Angular al final
generate-api-client:
  stage: generate
  image: node:20.17.0
  script:
    - npm install -g @angular/cli@19
    - npm install -g openapi-typescript-codegen
    - git clone https://oauth2:${CI_PUSH_TOKEN}@gitlab.com/projects-dev4/adavec/prefactura-api-client.git api-client
    - cd api-client
    - rm -rf src/app/api
    - npx openapi-typescript-codegen --input https://transporte-api-latest.onrender.com/v3/api-docs --output src/app/api --client axios
    - git config user.email "ci-bot@example.com"
    - git config user.name "CI Bot"
    - git add src/app/api
    - git commit -m "üîÅ Auto-generado desde backend commit $CI_COMMIT_SHORT_SHA" || echo "Sin cambios"
    - git push origin main
  only:
    - main
